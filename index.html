<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attenza — Firebase Demo (Hybrid)</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --accent:#0b75ff; --muted:#6b7280; --radius:12px;
    }
    body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);margin:0;padding:28px;color:#0f172a;}
    .wrap{max-width:980px;margin:0 auto;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 18px rgba(10,20,40,0.06);padding:18px}
    form .row{display:flex;gap:10px;margin-bottom:10px}
    label{font-size:13px;color:var(--muted)}
    input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(10,20,30,0.06);width:100%}
    button{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    .schedule-day{margin-top:14px}
    .slot{display:grid;grid-template-columns:100px 1fr 170px 160px;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);margin-bottom:10px;align-items:center}
    .slot-time{font-weight:700;color:var(--accent)}
    .slot-subject{font-weight:700}
    .slot-meta{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px;justify-self:end}
    .btn-lite{border-radius:8px;padding:8px 10px;border:1px solid rgba(10,20,30,0.06);background:transparent;cursor:pointer}
    .present{background:#10b981;color:white;border:none}
    .absent{background:#ef4444;color:white;border:none}
    .notheld{background:transparent;border:1px dashed rgba(10,20,30,0.06);color:var(--muted)}
    .hidden{display:none}
    .topline{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .profile{display:flex;gap:12px;align-items:center}
    .pill{background:rgba(10,20,30,0.04);padding:8px 10px;border-radius:999px;font-weight:700}
    footer{margin-top:20px;color:var(--muted);font-size:13px}
    @media(max-width:780px){ .slot{grid-template-columns:1fr;grid-template-rows:auto auto auto auto} .actions{justify-self:start} .slot-time{text-align:left} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Attenza — Firebase Demo (Hybrid)</h1>
      <div class="small">Firebase Auth + Firestore + Google Sheet import</div>
    </header>

    <div id="authCard" class="card">
      <div class="topline">
        <div>
          <div style="font-weight:700;">Sign up / Sign in</div>
          <div class="small">On signup the schedule is imported once from your Google Sheet and stored in Firestore.</div>
        </div>
        <div class="profile">
          <div id="userEmail" class="small"></div>
        </div>
      </div>

      <div id="authForms">
        <form id="signupForm">
          <div class="row">
            <div style="flex:1">
              <label>Email</label>
              <input id="email" type="email" required placeholder="you@example.com" />
            </div>
            <div style="width:200px">
              <label>Password</label>
              <input id="password" type="password" required placeholder="min 6 chars"/>
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Class</label>
              <select id="classSelect">
                <option value="HS1">HS1</option>
                <option value="HS2">HS2</option>
                <option value="BCom1st">BCom1st</option>
                <option value="BCom3rd">BCom3rd</option>
                <option value="BCom5th">BCom5th</option>
              </select>
            </div>
            <div style="width:160px">
              <label>Section</label>
              <select id="sectionSelect">
                <option value="">—</option>
                <option value="A">A</option>
                <option value="B">B</option>
              </select>
            </div>
          </div>

          <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
            <button id="signupBtn" type="submit">Create account & import schedule</button>
            <button id="signinBtn" type="button" class="btn-lite">Sign in</button>
          </div>
          <div id="authMsg" class="small" style="margin-top:8px;color:#b91c1c"></div>
        </form>
      </div>
    </div>

    <div id="dashboard" class="card hidden">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:700" id="dashTitle">Today’s classes</div>
          <div class="small" id="dashSubtitle"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="pill" id="userInfoPill"></div>
          <button id="signoutBtn" class="btn-lite">Sign out</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <label class="small">Show day</label>
        <select id="dayPicker" style="margin-top:6px;padding:8px;border-radius:8px;border:1px solid rgba(10,20,30,0.06)">
          <option value="today">Show Today</option>
          <option value="monday">Monday</option>
          <option value="tuesday">Tuesday</option>
          <option value="wednesday">Wednesday</option>
          <option value="thursday">Thursday</option>
          <option value="friday">Friday</option>
          <option value="saturday">Saturday</option>
        </select>
      </div>

      <div id="scheduleContainer" class="schedule-day" style="margin-top:14px"></div>
      <footer>
        This demo stores schedule in Firestore and caches a copy in localStorage for speed/offline.
      </footer>
    </div>
  </div>

  <script type="module">
    // ---------- Firebase config (you provided) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, writeBatch, getDocs, query, where, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDKhSmOS8RWfzlopEzNgePkXz4YRfN3RCU",
      authDomain: "fir-7692e.firebaseapp.com",
      projectId: "fir-7692e",
      storageBucket: "fir-7692e.firebasestorage.app",
      messagingSenderId: "485742538114",
      appId: "1:485742538114:web:1ae70e18131ff2489a339b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- IMPORTANT: replace with your published CSV URL ----------
    // Publish your Google Sheet (File -> Publish to web -> CSV) and paste the CSV URL here.
    let SCHEDULE_CSV_URL = "REPLACE_WITH_YOUR_PUBLISHED_CSV_URL";

    // ---------- Helpers ----------
    const $ = id => document.getElementById(id);
    const todayName = ()=> ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'][new Date().getDay()];

    // Simple CSV parser suitable for our published CSV (no embedded commas)
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/).filter(Boolean);
      const header = lines.shift().split(',').map(h=>h.trim());
      return lines.map(line=>{
        const cols = line.split(',').map(c=>c.trim());
        const obj = {};
        header.forEach((h,i)=> obj[h]=cols[i] ?? '');
        return obj;
      });
    }

    // Fetch CSV
    async function fetchMasterCsv(url){
      const res = await fetch(url);
      if(!res.ok) throw new Error('Failed to load CSV: '+res.status);
      const txt = await res.text();
      return parseCSV(txt);
    }

    // Firestore helpers: write user profile and schedule snapshot (batch)
    async function saveUserProfile(uid, profile){
      const ref = doc(db, 'users', uid);
      await setDoc(ref, {...profile, createdAt: serverTimestamp()});
    }

    async function writeUserSchedule(uid, rows){
      // rows: array objects with fields day,class,section,start_time,subject,room,faculty
      const batch = writeBatch(db);
      rows.forEach(r=>{
        const safeSubject = (r.subject||'').replace(/\s+/g,'_').replace(/[^\w\-]/g,'');
        const slotId = `${r.day}_${r.start_time}_${safeSubject}`.toLowerCase();
        const ref = doc(db, 'users', uid, 'schedule', slotId);
        batch.set(ref, {
          day: r.day,
          start_time: r.start_time,
          subject_label: r.subject,
          room: r.room,
          faculty: r.faculty,
          createdAt: serverTimestamp()
        });
      });
      await batch.commit();
    }

    // Read schedule for a user for a given day (query)
    async function getScheduleForDay(uid, day){
      const colRef = collection(db, 'users', uid, 'schedule');
      const q = query(colRef, where('day','==',day));
      const snap = await getDocs(q);
      return snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=> (a.start_time||'').localeCompare(b.start_time||''));
    }

    // Save attendance doc (one small doc)
    async function saveAttendance(uid, dateISO, slotId, status, remark=''){
      const attDocId = `${dateISO}_${slotId}`;
      const ref = doc(db, 'users', uid, 'attendance', attDocId);
      await setDoc(ref, {
        slotId, date: dateISO, status, remark, updatedAt: serverTimestamp()
      });
      // Save local cache too
      try {
        const key = `att_cache:${uid}:${dateISO}:${slotId}`;
        localStorage.setItem(key, status);
      } catch(e){}
    }

    // Load attendance from local cache (fast)
    function loadAttendanceLocal(uid, dateISO, slotId){
      try{
        const key = `att_cache:${uid}:${dateISO}:${slotId}`;
        return localStorage.getItem(key) || '';
      }catch(e){ return ''; }
    }

    // ---------- UI wiring ----------
    const signupForm = $('signupForm');
    const signinBtn = $('signinBtn');
    const authMsg = $('authMsg');
    const authCard = $('authCard');
    const dashboard = $('dashboard');
    const scheduleContainer = $('scheduleContainer');
    const userInfoPill = $('userInfoPill');
    const userEmailEl = $('userEmail');
    const dayPicker = $('dayPicker');
    const signoutBtn = $('signoutBtn');

    let CURRENT_USER = null;
    let MASTER_SCHEDULE = []; // not used as canonical after import, but kept for convenience

    // Build schedule rows to render
    function renderScheduleRows(rows, uid){
      scheduleContainer.innerHTML = '';
      if(!rows.length){
        scheduleContainer.innerHTML = '<div class="small">No classes for this day.</div>';
        return;
      }
      rows.forEach(row=>{
        const div = document.createElement('div'); div.className='slot';
        const time = document.createElement('div'); time.className='slot-time'; time.textContent = row.start_time || '—';
        const subj = document.createElement('div'); subj.className='slot-subject';
        subj.innerHTML = `<div>${row.subject_label || row.subject || '—'}</div><div class="small">${row.class?row.class:''} ${row.section?(' • '+row.section):''}</div>`;
        const meta = document.createElement('div'); meta.className='slot-meta';
        meta.innerHTML = `<div>Room: ${row.room || '—'}</div><div>Faculty: ${row.faculty || '—'}</div>`;
        const actions = document.createElement('div'); actions.className='actions';

        const pBtn = document.createElement('button'); pBtn.className='present'; pBtn.textContent='Present';
        const aBtn = document.createElement('button'); aBtn.className='absent'; aBtn.textContent='Absent';
        const nBtn = document.createElement('button'); nBtn.className='notheld'; nBtn.textContent='Not Held';
        const statusSpan = document.createElement('div'); statusSpan.className='small';

        // derive slotId same way as writeUserSchedule
        const safeSubject = (row.subject_label||row.subject||'').replace(/\s+/g,'_').replace(/[^\w\-]/g,'');
        const slotId = `${row.day}_${row.start_time}_${safeSubject}`.toLowerCase();
        const dateISO = new Date().toISOString().slice(0,10);
        // set initial status from local cache
        const localStatus = loadAttendanceLocal(CURRENT_USER.uid, dateISO, slotId);
        if(localStatus) statusSpan.textContent = localStatus.toUpperCase();

        pBtn.onclick = async ()=>{ statusSpan.textContent='PRESENT'; await saveAttendance(CURRENT_USER.uid, dateISO, slotId, 'present'); };
        aBtn.onclick = async ()=>{ statusSpan.textContent='ABSENT'; await saveAttendance(CURRENT_USER.uid, dateISO, slotId, 'absent'); };
        nBtn.onclick = async ()=>{ statusSpan.textContent='NOT HELD'; await saveAttendance(CURRENT_USER.uid, dateISO, slotId, 'not_held'); };

        actions.appendChild(pBtn); actions.appendChild(aBtn); actions.appendChild(nBtn);
        div.appendChild(time); div.appendChild(subj); div.appendChild(meta); div.appendChild(actions);
        scheduleContainer.appendChild(div);
      });
    }

    async function updateScheduleView(){
      const day = (dayPicker.value === 'today') ? todayName() : dayPicker.value;
      // try read from Firestore
      try{
        const rows = await getScheduleForDay(CURRENT_USER.uid, day);
        // if no rows in firestore, fallback to local snapshot
        if(rows.length === 0){
          const snap = localStorage.getItem(`attenza_schedule:${CURRENT_USER.email}`);
          if(snap){
            const arr = JSON.parse(snap).filter(r=> r.day === day);
            renderScheduleRows(arr, CURRENT_USER.uid);
            $('dashSubtitle').textContent = `${day.charAt(0).toUpperCase()+day.slice(1)} • ${arr.length} slot(s) (cached)`;
            return;
          }
        }
        renderScheduleRows(rows, CURRENT_USER.uid);
        $('dashSubtitle').textContent = `${day.charAt(0).toUpperCase()+day.slice(1)} • ${rows.length} slot(s)`;
      }catch(err){
        console.warn('Firestore read failed, falling back to local snapshot', err);
        const snap = localStorage.getItem(`attenza_schedule:${CURRENT_USER.email}`);
        if(snap){
          const arr = JSON.parse(snap).filter(r=> r.day === (day === 'today' ? todayName() : day));
          renderScheduleRows(arr, CURRENT_USER.uid);
          $('dashSubtitle').textContent = `${day.charAt(0).toUpperCase()+day.slice(1)} • ${arr.length} slot(s) (cached)`;
        } else {
          scheduleContainer.innerHTML = '<div class="small">Unable to load schedule (check network or published CSV URL).</div>';
        }
      }
    }

    // ---------- Signup flow: create auth user, fetch CSV, write profile & schedule ----------
    signupForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      authMsg.textContent = '';
      const email = $('email').value.trim();
      const pwd = $('password').value;
      const classCode = $('classSelect').value;
      const section = $('sectionSelect').value;
      if(!SCHEDULE_CSV_URL || SCHEDULE_CSV_URL.includes('REPLACE_WITH')) {
        authMsg.textContent = 'Set SCHEDULE_CSV_URL in the code to your published Google Sheet CSV URL.';
        return;
      }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pwd);
        const uid = cred.user.uid;
        // Fetch CSV (master)
        const master = await fetchMasterCsv(SCHEDULE_CSV_URL);
        MASTER_SCHEDULE = master; // keep copy for debugging
        // Filter rows for this class + section (match empty section for HS)
        const snapshotRows = master.filter(r => (r.class||'') === classCode && ((r.section||'') === section || (section === '' && (r.section||'')==='')));
        // save profile & schedule to Firestore
        const profile = { email, class: classCode, section };
        await saveUserProfile(uid, profile);
        if(snapshotRows.length) await writeUserSchedule(uid, snapshotRows);
        // Cache snapshot locally
        localStorage.setItem(`attenza_profile:${email}`, JSON.stringify({ uid, email, class: classCode, section }));
        localStorage.setItem(`attenza_schedule:${email}`, JSON.stringify(snapshotRows));
        // set current user and show dashboard
        CURRENT_USER = { uid, email };
        showDashboardFor({ uid, email, class: classCode, section });
      }catch(err){
        console.error(err);
        authMsg.textContent = err.message || 'Signup failed';
      }
    });

    // Sign in
    signinBtn.addEventListener('click', async ()=>{
      authMsg.textContent = '';
      const email = $('email').value.trim();
      const pwd = $('password').value;
      if(!email || !pwd){ authMsg.textContent = 'Enter email & password to sign in.'; return; }
      try{
        const cred = await signInWithEmailAndPassword(auth, email, pwd);
        const uid = cred.user.uid;
        // load profile from local cache if available else from Firestore profile
        const saved = localStorage.getItem(`attenza_profile:${email}`);
        let profile = saved ? JSON.parse(saved) : null;
        if(!profile){
          const docRef = doc(db, 'users', uid);
          const snap = await getDoc(docRef);
          if(snap.exists()){
            const data = snap.data();
            profile = { uid, email, class: data.class || data.classCode || '', section: data.section || '' };
            localStorage.setItem(`attenza_profile:${email}`, JSON.stringify(profile));
          } else {
            profile = { uid, email, class: $('classSelect').value, section: $('sectionSelect').value };
          }
        }
        CURRENT_USER = profile;
        // if schedule snapshot cached locally, reuse; otherwise rely on Firestore reads (updateScheduleView handles fallback)
        const snap = localStorage.getItem(`attenza_schedule:${email}`);
        if(snap) MASTER_SCHEDULE = JSON.parse(snap);
        showDashboardFor(profile);
      }catch(err){
        console.error(err);
        authMsg.textContent = err.message || 'Sign-in failed';
      }
    });

    // show dashboard
    function showDashboardFor(profile){
      CURRENT_USER = profile;
      $('authCard').classList.add('hidden');
      $('dashboard').classList.remove('hidden');
      userInfoPill.textContent = `${profile.email} • ${profile.class}${profile.section?(' • ' + profile.section):''}`;
      userEmailEl.textContent = profile.email;
      dayPicker.value = 'today';
      updateScheduleView();
    }

    signoutBtn.addEventListener('click', async ()=>{
      await signOut(auth);
      CURRENT_USER = null;
      $('authCard').classList.remove('hidden');
      $('dashboard').classList.add('hidden');
    });

    dayPicker.addEventListener('change', updateScheduleView);

    // Auth state listener to keep UI in sync across tabs
    onAuthStateChanged(auth, (user)=>{
      if(user){
        const saved = localStorage.getItem(`attenza_profile:${user.email}`);
        if(saved){
          const profile = JSON.parse(saved);
          CURRENT_USER = profile;
          showDashboardFor(profile);
        } else {
          // keep auth card visible to import schedule
          $('authCard').classList.remove('hidden');
          $('dashboard').classList.add('hidden');
        }
      } else {
        $('authCard').classList.remove('hidden');
        $('dashboard').classList.add('hidden');
      }
    });

  </script>
</body>
</html>
